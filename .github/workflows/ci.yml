# CI/CD Pipeline - Tests, Linting y Build
name: CI/CD

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

# Cancelar workflows anteriores si hay un nuevo push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Lint y Type Check
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint

      - name: Type check
        run: pnpm exec tsc --noEmit

      - name: Generate Payload types
        run: pnpm generate:types
        env:
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET || 'test-secret-for-ci-only-must-be-at-least-32-chars' }}
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL || 'file:./test.db' }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN || 'test-token' }}

  # Job 2: Tests de Integración
  # NOTA: Descomenta esta sección cuando tengas tests implementados
  # test-integration:
  #   name: Integration Tests
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 15

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup pnpm
  #       uses: pnpm/action-setup@v4
  #       with:
  #         version: 10

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'pnpm'

  #     - name: Install dependencies
  #       run: pnpm install --frozen-lockfile

  #     - name: Run integration tests
  #       run: pnpm test:int
  #       env:
  #         PAYLOAD_SECRET: test-secret-for-ci-only-must-be-at-least-32-chars
  #         TURSO_DATABASE_URL: file:./test.db
  #         TURSO_AUTH_TOKEN: test-token
  #         NODE_ENV: test

  #     - name: Upload coverage reports
  #       if: always()
  #       uses: codecov/codecov-action@v4
  #       with:
  #         files: ./coverage/coverage-final.json
  #         flags: integration
  #         fail_ci_if_error: false
  #       continue-on-error: true

  # Job 3: Tests E2E con Playwright
  # NOTA: Descomenta esta sección cuando tengas tests E2E implementados
  # test-e2e:
  #   name: E2E Tests
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 20

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup pnpm
  #       uses: pnpm/action-setup@v4
  #       with:
  #         version: 10

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'pnpm'

  #     - name: Install dependencies
  #       run: pnpm install --frozen-lockfile

  #     - name: Install Playwright browsers
  #       run: pnpm exec playwright install --with-deps chromium

  #     - name: Run E2E tests
  #       run: pnpm test:e2e
  #       env:
  #         PAYLOAD_SECRET: test-secret-for-ci-only-must-be-at-least-32-chars
  #         TURSO_DATABASE_URL: file:./test.db
  #         TURSO_AUTH_TOKEN: test-token
  #         NODE_ENV: test

  #     - name: Upload Playwright report
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: playwright-report
  #         path: playwright-report/
  #         retention-days: 30

  #     - name: Upload test results
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: test-results
  #         path: test-results/
  #         retention-days: 7

  # Job 4: Build
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint]
    # NOTA: Cuando tengas tests, agrega: needs: [lint, test-integration]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build
        env:
          PAYLOAD_SECRET: test-secret-for-ci-only-must-be-at-least-32-chars
          TURSO_DATABASE_URL: file:./test.db
          TURSO_AUTH_TOKEN: test-token
          R2_BUCKET_NAME: test-bucket
          R2_ACCESS_KEY_ID: test-key
          R2_SECRET_ACCESS_KEY: test-secret
          R2_ENDPOINT: https://test.r2.cloudflarestorage.com
          NODE_ENV: production

      - name: Check build size
        run: |
          echo "Build completed successfully!"
          du -sh .next || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: .next/
          retention-days: 7

  # Job 5: Security Check
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Run security audit
        run: pnpm audit --prod
        continue-on-error: true

      - name: Check for vulnerabilities
        run: |
          echo "Security audit completed"
          pnpm audit --audit-level=high --prod || echo "::warning::High severity vulnerabilities found"

  # Job 6: Notificación de éxito
  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [lint, build, security]
    # NOTA: Cuando tengas tests, agrega: needs: [lint, test-integration, test-e2e, build, security]
    if: success()

    steps:
      - name: Success notification
        run: |
          echo "✅ All checks passed!"
          echo "- Linting: ✅"
          echo "- Build: ✅"
          echo "- Security: ✅"
          # echo "- Integration Tests: ✅"  # Descomenta cuando tengas tests
          # echo "- E2E Tests: ✅"  # Descomenta cuando tengas tests

          echo "### ✅ All CI Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linting | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | ✅ |" >> $GITHUB_STEP_SUMMARY
          # echo "| Integration Tests | ✅ |" >> $GITHUB_STEP_SUMMARY  # Descomenta cuando tengas tests
          # echo "| E2E Tests | ✅ |" >> $GITHUB_STEP_SUMMARY  # Descomenta cuando tengas tests
